"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// tslint:disable: no-console
// tslint:disable: max-line-length
/* eslint-disable @typescript-eslint/no-require-imports */
const cfnResponse = require("../../lib/provider-framework/runtime/cfn-response");
const framework = require("../../lib/provider-framework/runtime/framework");
const outbound = require("../../lib/provider-framework/runtime/outbound");
const mocks = require("./mocks");
/* eslint-enable */
console.log = jest.fn();
cfnResponse.includeStackTraces = false;
const MOCK_PHYSICAL_ID = 'mock-physical-resource-id';
const MOCK_PROPS = { Name: 'Value', List: ['1', '2', '3'], ServiceToken: 'bla' };
const MOCK_ATTRS = { MyAttribute: 'my-mock-attribute' };
outbound.httpRequest = mocks.httpRequestMock;
outbound.invokeFunction = mocks.invokeFunctionMock;
outbound.startExecution = mocks.startExecutionMock;
beforeEach(() => mocks.setup());
test('async flow: isComplete returns true only after 3 times', async () => {
    let isCompleteCalls = 0;
    mocks.onEventImplMock = async (event) => {
        expect(event.RequestType).toEqual('Create');
        expect(event.ResourceProperties).toStrictEqual(MOCK_PROPS);
        expect(event.PhysicalResourceId).toBeUndefined(); // physical ID in CREATE
        return {
            PhysicalResourceId: MOCK_PHYSICAL_ID,
            Data: MOCK_ATTRS,
            ArbitraryField: 1234,
        };
    };
    mocks.isCompleteImplMock = async (event) => {
        isCompleteCalls++;
        expect(event.ArbitraryField).toEqual(1234); // any field is passed through
        expect(event.PhysicalResourceId).toEqual(MOCK_PHYSICAL_ID); // physical ID returned from onEvent is passed to "isComplete"
        expect(event.Data).toStrictEqual(MOCK_ATTRS); // attributes are propagated between the calls
        const result = isCompleteCalls === 3;
        if (!result) {
            return {
                IsComplete: false,
            };
        }
        return {
            IsComplete: true,
            Data: {
                Additional: 'attribute',
            },
        };
    };
    // WHEN
    await simulateEvent({
        RequestType: 'Create',
        ResourceProperties: MOCK_PROPS,
    });
    // THEN
    expect(isCompleteCalls).toEqual(3);
    expectCloudFormationSuccess({
        PhysicalResourceId: MOCK_PHYSICAL_ID,
        Data: {
            ...MOCK_ATTRS,
            Additional: 'attribute',
        },
    });
});
test('isComplete throws in the first invocation', async () => {
    // GIVEN
    mocks.onEventImplMock = async () => ({ PhysicalResourceId: MOCK_PHYSICAL_ID });
    mocks.isCompleteImplMock = async () => { throw new Error('Some failure'); };
    // WHEN
    await simulateEvent({
        RequestType: 'Create',
        ResourceProperties: MOCK_PROPS,
    });
    expectCloudFormationFailed('Some failure\n\nLogs: /aws/lambda/complete\n');
});
test('fails gracefully if "onEvent" throws an error', async () => {
    // GIVEN
    mocks.onEventImplMock = async () => { throw new Error('error thrown during onEvent'); };
    mocks.isCompleteImplMock = async () => ({ IsComplete: true });
    // WHEN
    await simulateEvent({
        RequestType: 'Create',
    });
    // THEN
    expectCloudFormationFailed('error thrown during onEvent\n\nLogs: /aws/lambda/event\n');
    expectNoWaiter();
});
describe('PhysicalResourceId', () => {
    describe('if not omitted from onEvent result', () => {
        it('defaults to RequestId for CREATE', async () => {
            // WHEN
            mocks.onEventImplMock = async () => undefined;
            // THEN
            await simulateEvent({
                RequestType: 'Create',
            });
            expectCloudFormationSuccess({
                PhysicalResourceId: mocks.MOCK_REQUEST.RequestId,
            });
        });
        it('defaults to the current PhysicalResourceId for UPDATE', async () => {
            // WHEN
            mocks.onEventImplMock = async () => undefined;
            // THEN
            await simulateEvent({
                RequestType: 'Update',
                PhysicalResourceId: MOCK_PHYSICAL_ID,
            });
            expectCloudFormationSuccess({
                PhysicalResourceId: MOCK_PHYSICAL_ID,
            });
        });
        it('defaults to the current PhysicalResourceId for DELETE', async () => {
            // WHEN
            mocks.onEventImplMock = async () => undefined;
            // THEN
            await simulateEvent({
                RequestType: 'Delete',
                PhysicalResourceId: MOCK_PHYSICAL_ID,
            });
            expectCloudFormationSuccess({
                PhysicalResourceId: MOCK_PHYSICAL_ID,
            });
        });
    });
    test('UPDATE: can change the physical ID by returning a new ID', async () => {
        // GIVEN
        mocks.onEventImplMock = async () => ({ PhysicalResourceId: 'NewPhysicalId' });
        mocks.isCompleteImplMock = async () => ({ IsComplete: true });
        // WHEN
        await simulateEvent({
            RequestType: 'Update',
            PhysicalResourceId: 'CurrentPhysicalId',
        });
        // THEN
        expectCloudFormationSuccess({
            PhysicalResourceId: 'NewPhysicalId',
        });
    });
    test('DELETE: cannot change the physical resource ID during a delete', async () => {
        // GIVEN
        mocks.onEventImplMock = async () => ({ PhysicalResourceId: 'NewPhysicalId' });
        mocks.isCompleteImplMock = async () => ({ IsComplete: true });
        // WHEN
        await simulateEvent({
            RequestType: 'Delete',
            PhysicalResourceId: 'CurrentPhysicalId',
        });
        // THEN
        expectNoWaiter();
        expectCloudFormationFailed('DELETE: cannot change the physical resource ID from "CurrentPhysicalId" to "NewPhysicalId" during deletion');
    });
});
test('isComplete always returns "false" and then a timeout occurs', async () => {
    // GIVEN
    mocks.onEventImplMock = async () => ({ Data: { Foo: 123 }, PhysicalResourceId: MOCK_PHYSICAL_ID });
    mocks.isCompleteImplMock = async () => ({ IsComplete: false });
    // WHEN
    await simulateEvent({
        RequestType: 'Update',
        PhysicalResourceId: MOCK_PHYSICAL_ID,
    });
    // THEN
    expectCloudFormationFailed('Operation timed out');
});
test('isComplete: "Data" is not allowed if InComplete is "False"', async () => {
    // GIVEN
    mocks.onEventImplMock = async () => ({ Data: { Foo: 123 }, PhysicalResourceId: MOCK_PHYSICAL_ID });
    mocks.isCompleteImplMock = async () => ({ IsComplete: false, Data: { Foo: 3333 } });
    // WHEN
    await simulateEvent({
        RequestType: 'Update',
        PhysicalResourceId: MOCK_PHYSICAL_ID,
    });
    expectCloudFormationFailed('"Data" is not allowed if "IsComplete" is "False"');
});
test('if there is no user-defined "isComplete", the waiter will not be triggered or needed', async () => {
    // GIVEN
    mocks.onEventImplMock = async () => ({ PhysicalResourceId: MOCK_PHYSICAL_ID });
    // WHEN
    await simulateEvent({
        RequestType: 'Create',
    });
    // THEN
    expectNoWaiter();
    expectCloudFormationSuccess({ PhysicalResourceId: MOCK_PHYSICAL_ID });
});
test('fails if user handler returns a non-object response', async () => {
    // GIVEN
    mocks.stringifyPayload = false;
    mocks.onEventImplMock = async () => 'string';
    // WHEN
    await simulateEvent({ RequestType: 'Create' });
    // THEN
    expectCloudFormationFailed('return values from user-handlers must be JSON objects. got: \"string\"');
});
describe('if CREATE fails, the subsequent DELETE will be ignored', () => {
    it('FAILED response sets PhysicalResourceId to a special marker', async () => {
        // WHEN
        mocks.onEventImplMock = async () => { throw new Error('CREATE FAILED'); };
        // THEN
        await simulateEvent({
            RequestType: 'Create',
        });
        expectCloudFormationFailed('CREATE FAILED\n\nLogs: /aws/lambda/event\n', {
            PhysicalResourceId: cfnResponse.CREATE_FAILED_PHYSICAL_ID_MARKER,
        });
    });
    it('DELETE request with the marker succeeds without calling user handler', async () => {
        // GIVEN
        // user handler is not assigned
        // WHEN
        await simulateEvent({
            RequestType: 'Delete',
            PhysicalResourceId: cfnResponse.CREATE_FAILED_PHYSICAL_ID_MARKER,
        });
        // THEN
        expectCloudFormationSuccess();
    });
});
// -----------------------------------------------------------------------------------------------------------------------
/**
 * Triggers the custom resource lifecycle event flow by invoking the framework's
 * onEvent function and then, if the waiter state machine was started, simulates
 * the waiter and invokes isComplete and onTimeout as appropriate.
 */
async function simulateEvent(req) {
    const x = {
        ServiceToken: 'SERVICE-TOKEN',
        ResponseURL: mocks.MOCK_REQUEST.ResponseURL,
        StackId: mocks.MOCK_REQUEST.StackId,
        RequestId: mocks.MOCK_REQUEST.RequestId,
        ResourceType: 'Custom::TestResource',
        LogicalResourceId: mocks.MOCK_REQUEST.LogicalResourceId,
        ...req,
    };
    mocks.prepareForExecution();
    await framework.onEvent(x);
    // if the FSM
    if (mocks.startStateMachineInput && mocks.startStateMachineInput.stateMachineArn === mocks.MOCK_SFN_ARN) {
        await simulateWaiter(JSON.parse(mocks.startStateMachineInput.input));
    }
    async function simulateWaiter(event) {
        let retry = true;
        let count = 5;
        while (retry) {
            try {
                await framework.isComplete(event);
                retry = false;
            }
            catch (e) {
                if (e instanceof cfnResponse.Retry) {
                    if (count-- === 0) {
                        await framework.onTimeout({ Cause: JSON.stringify({ errorMessage: e.message }) });
                        retry = false;
                    }
                    else {
                        retry = true;
                        continue;
                    }
                }
                else {
                    throw new Error(e);
                }
            }
        }
    }
}
function expectCloudFormationFailed(expectedReason, resp) {
    expectCloudFormationResponse({
        Status: 'FAILED',
        Reason: expectedReason,
        ...resp,
    });
}
function expectCloudFormationSuccess(resp) {
    if (mocks.cfnResponse.Status !== 'SUCCESS') {
        console.error(mocks.cfnResponse.Reason || '<NO REASON>');
    }
    expectCloudFormationResponse({ Status: 'SUCCESS', ...resp });
}
function expectCloudFormationResponse(resp = {}) {
    for (const [key, expected] of Object.entries(resp)) {
        const actual = mocks.cfnResponse[key];
        expect(actual).toStrictEqual(expected);
    }
}
function expectNoWaiter() {
    expect(mocks.startStateMachineInput).toBeUndefined();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicnVudGltZS50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicnVudGltZS50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsNkJBQTZCO0FBQzdCLGtDQUFrQztBQUNsQywwREFBMEQ7QUFDMUQsaUZBQWtGO0FBQ2xGLDRFQUE2RTtBQUM3RSwwRUFBMkU7QUFDM0UsaUNBQWtDO0FBQ2xDLG1CQUFtQjtBQUVuQixPQUFPLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQztBQUV4QixXQUFXLENBQUMsa0JBQWtCLEdBQUcsS0FBSyxDQUFDO0FBRXZDLE1BQU0sZ0JBQWdCLEdBQUcsMkJBQTJCLENBQUM7QUFDckQsTUFBTSxVQUFVLEdBQUcsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBRSxDQUFDO0FBQ2pGLE1BQU0sVUFBVSxHQUFHLEVBQUUsV0FBVyxFQUFFLG1CQUFtQixFQUFFLENBQUM7QUFFeEQsUUFBUSxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUMsZUFBZSxDQUFDO0FBQzdDLFFBQVEsQ0FBQyxjQUFjLEdBQUcsS0FBSyxDQUFDLGtCQUFrQixDQUFDO0FBQ25ELFFBQVEsQ0FBQyxjQUFjLEdBQUcsS0FBSyxDQUFDLGtCQUFrQixDQUFDO0FBRW5ELFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQztBQUVoQyxJQUFJLENBQUMsd0RBQXdELEVBQUUsS0FBSyxJQUFJLEVBQUU7SUFDeEUsSUFBSSxlQUFlLEdBQUcsQ0FBQyxDQUFDO0lBRXhCLEtBQUssQ0FBQyxlQUFlLEdBQUcsS0FBSyxFQUFDLEtBQUssRUFBQyxFQUFFO1FBQ3BDLE1BQU0sQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxD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RUFBRSxDQUFDLENBQUM7QUFDL0QsQ0FBQztBQUVELFNBQVMsNEJBQTRCLENBQUMsT0FBZ0UsRUFBRTtJQUN0RyxLQUFLLE1BQU0sQ0FBQyxHQUFHLEVBQUUsUUFBUSxDQUFDLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTtRQUNsRCxNQUFNLE1BQU0sR0FBSSxLQUFLLENBQUMsV0FBbUIsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMvQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsYUFBYSxDQUFDLFFBQWUsQ0FBQyxDQUFDO0tBQy9DO0FBQ0gsQ0FBQztBQUVELFNBQVMsY0FBYztJQUNyQixNQUFNLENBQUMsS0FBSyxDQUFDLHNCQUFzQixDQUFDLENBQUMsYUFBYSxFQUFFLENBQUM7QUFDdkQsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIHRzbGludDpkaXNhYmxlOiBuby1jb25zb2xlXG4vLyB0c2xpbnQ6ZGlzYWJsZTogbWF4LWxpbmUtbGVuZ3RoXG4vKiBlc2xpbnQtZGlzYWJsZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tcmVxdWlyZS1pbXBvcnRzICovXG5pbXBvcnQgY2ZuUmVzcG9uc2UgPSByZXF1aXJlKCcuLi8uLi9saWIvcHJvdmlkZXItZnJhbWV3b3JrL3J1bnRpbWUvY2ZuLXJlc3BvbnNlJyk7XG5pbXBvcnQgZnJhbWV3b3JrID0gcmVxdWlyZSgnLi4vLi4vbGliL3Byb3ZpZGVyLWZyYW1ld29yay9ydW50aW1lL2ZyYW1ld29yaycpO1xuaW1wb3J0IG91dGJvdW5kID0gcmVxdWlyZSgnLi4vLi4vbGliL3Byb3ZpZGVyLWZyYW1ld29yay9ydW50aW1lL291dGJvdW5kJyk7XG5pbXBvcnQgbW9ja3MgPSByZXF1aXJlKCcuL21vY2tzJyk7XG4vKiBlc2xpbnQtZW5hYmxlICovXG5cbmNvbnNvbGUubG9nID0gamVzdC5mbigpO1xuXG5jZm5SZXNwb25zZS5pbmNsdWRlU3RhY2tUcmFjZXMgPSBmYWxzZTtcblxuY29uc3QgTU9DS19QSFlTSUNBTF9JRCA9ICdtb2NrLXBoeXNpY2FsLXJlc291cmNlLWlkJztcbmNvbnN0IE1PQ0tfUFJPUFMgPSB7IE5hbWU6ICdWYWx1ZScsIExpc3Q6IFsnMScsICcyJywgJzMnXSwgU2VydmljZVRva2VuOiAnYmxhJyB9O1xuY29uc3QgTU9DS19BVFRSUyA9IHsgTXlBdHRyaWJ1dGU6ICdteS1tb2NrLWF0dHJpYnV0ZScgfTtcblxub3V0Ym91bmQuaHR0cFJlcXVlc3QgPSBtb2Nrcy5odHRwUmVxdWVzdE1vY2s7XG5vdXRib3VuZC5pbnZva2VGdW5jdGlvbiA9IG1vY2tzLmludm9rZUZ1bmN0aW9uTW9jaztcbm91dGJvdW5kLnN0YXJ0RXhlY3V0aW9uID0gbW9ja3Muc3RhcnRFeGVjdXRpb25Nb2NrO1xuXG5iZWZvcmVFYWNoKCgpID0+IG1vY2tzLnNldHVwKCkpO1xuXG50ZXN0KCdhc3luYyBmbG93OiBpc0NvbXBsZXRlIHJldHVybnMgdHJ1ZSBvbmx5IGFmdGVyIDMgdGltZXMnLCBhc3luYyAoKSA9PiB7XG4gIGxldCBpc0NvbXBsZXRlQ2FsbHMgPSAwO1xuXG4gIG1vY2tzLm9uRXZlbnRJbXBsTW9jayA9IGFzeW5jIGV2ZW50ID0+IHtcbiAgICBleHBlY3QoZXZlbnQuUmVxdWVzdFR5cGUpLnRvRXF1YWwoJ0NyZWF0ZScpO1xuICAgIGV4cGVjdChldmVudC5SZXNvdXJjZVByb3BlcnRpZXMpLnRvU3RyaWN0RXF1YWwoTU9DS19QUk9QUyk7XG4gICAgZXhwZWN0KGV2ZW50LlBoeXNpY2FsUmVzb3VyY2VJZCkudG9CZVVuZGVmaW5lZCgpOyAvLyBwaHlzaWNhbCBJRCBpbiBDUkVBVEVcblxuICAgIHJldHVybiB7XG4gICAgICBQaHlzaWNhbFJlc291cmNlSWQ6IE1PQ0tfUEhZU0lDQUxfSUQsXG4gICAgICBEYXRhOiBNT0NLX0FUVFJTLFxuICAgICAgQXJiaXRyYXJ5RmllbGQ6IDEyMzQsXG4gICAgfTtcbiAgfTtcblxuICBtb2Nrcy5pc0NvbXBsZXRlSW1wbE1vY2sgPSBhc3luYyBldmVudCA9PiB7XG4gICAgaXNDb21wbGV0ZUNhbGxzKys7XG4gICAgZXhwZWN0KChldmVudCBhcyBhbnkpLkFyYml0cmFyeUZpZWxkKS50b0VxdWFsKDEyMzQpOyAvLyBhbnkgZmllbGQgaXMgcGFzc2VkIHRocm91Z2hcbiAgICBleHBlY3QoZXZlbnQuUGh5c2ljYWxSZXNvdXJjZUlkKS50b0VxdWFsKE1PQ0tfUEhZU0lDQUxfSUQpOyAvLyBwaHlzaWNhbCBJRCByZXR1cm5lZCBmcm9tIG9uRXZlbnQgaXMgcGFzc2VkIHRvIFwiaXNDb21wbGV0ZVwiXG4gICAgZXhwZWN0KGV2ZW50LkRhdGEpLnRvU3RyaWN0RXF1YWwoTU9DS19BVFRSUyk7IC8vIGF0dHJpYnV0ZXMgYXJlIHByb3BhZ2F0ZWQgYmV0d2VlbiB0aGUgY2FsbHNcblxuICAgIGNvbnN0IHJlc3VsdCA9IGlzQ29tcGxldGVDYWxscyA9PT0gMztcbiAgICBpZiAoIXJlc3VsdCkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgSXNDb21wbGV0ZTogZmFsc2UsXG4gICAgICB9O1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBJc0NvbXBsZXRlOiB0cnVlLFxuICAgICAgRGF0YToge1xuICAgICAgICBBZGRpdGlvbmFsOiAnYXR0cmlidXRlJywgLy8gYWRkaXRpb25hbCBhdHRyaWJ1dGVzIGNhbiBiZSByZXR1cm5lZCBmcm9tIFwiaXNDb21wbGV0ZVwiXG4gICAgICB9LFxuICAgIH07XG4gIH07XG5cbiAgLy8gV0hFTlxuICBhd2FpdCBzaW11bGF0ZUV2ZW50KHtcbiAgICBSZXF1ZXN0VHlwZTogJ0NyZWF0ZScsXG4gICAgUmVzb3VyY2VQcm9wZXJ0aWVzOiBNT0NLX1BST1BTLFxuICB9KTtcblxuICAvLyBUSEVOXG4gIGV4cGVjdChpc0NvbXBsZXRlQ2FsbHMpLnRvRXF1YWwoMyk7XG5cbiAgZXhwZWN0Q2xvdWRGb3JtYXRpb25TdWNjZXNzKHtcbiAgICBQaHlzaWNhbFJlc291cmNlSWQ6IE1PQ0tfUEhZU0lDQUxfSUQsXG4gICAgRGF0YToge1xuICAgICAgLi4uTU9DS19BVFRSUyxcbiAgICAgIEFkZGl0aW9uYWw6ICdhdHRyaWJ1dGUnLFxuICAgIH0sXG4gIH0pO1xufSk7XG5cbnRlc3QoJ2lzQ29tcGxldGUgdGhyb3dzIGluIHRoZSBmaXJzdCBpbnZvY2F0aW9uJywgYXN5bmMgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBtb2Nrcy5vbkV2ZW50SW1wbE1vY2sgPSBhc3luYyAoKSA9PiAoeyBQaHlzaWNhbFJlc291cmNlSWQ6IE1PQ0tfUEhZU0lDQUxfSUQgfSk7XG4gIG1vY2tzLmlzQ29tcGxldGVJbXBsTW9jayA9IGFzeW5jICgpID0+IHsgdGhyb3cgbmV3IEVycm9yKCdTb21lIGZhaWx1cmUnKTsgfTtcblxuICAvLyBXSEVOXG4gIGF3YWl0IHNpbXVsYXRlRXZlbnQoe1xuICAgIFJlcXVlc3RUeXBlOiAnQ3JlYXRlJyxcbiAgICBSZXNvdXJjZVByb3BlcnRpZXM6IE1PQ0tfUFJPUFMsXG4gIH0pO1xuXG4gIGV4cGVjdENsb3VkRm9ybWF0aW9uRmFpbGVkKCdTb21lIGZhaWx1cmVcXG5cXG5Mb2dzOiAvYXdzL2xhbWJkYS9jb21wbGV0ZVxcbicpO1xufSk7XG5cbnRlc3QoJ2ZhaWxzIGdyYWNlZnVsbHkgaWYgXCJvbkV2ZW50XCIgdGhyb3dzIGFuIGVycm9yJywgYXN5bmMgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBtb2Nrcy5vbkV2ZW50SW1wbE1vY2sgPSBhc3luYyAoKSA9PiB7IHRocm93IG5ldyBFcnJvcignZXJyb3IgdGhyb3duIGR1cmluZyBvbkV2ZW50Jyk7IH07XG4gIG1vY2tzLmlzQ29tcGxldGVJbXBsTW9jayA9IGFzeW5jICgpID0+ICh7IElzQ29tcGxldGU6IHRydWUgfSk7XG5cbiAgLy8gV0hFTlxuICBhd2FpdCBzaW11bGF0ZUV2ZW50KHtcbiAgICBSZXF1ZXN0VHlwZTogJ0NyZWF0ZScsXG4gIH0pO1xuXG4gIC8vIFRIRU5cbiAgZXhwZWN0Q2xvdWRGb3JtYXRpb25GYWlsZWQoJ2Vycm9yIHRocm93biBkdXJpbmcgb25FdmVudFxcblxcbkxvZ3M6IC9hd3MvbGFtYmRhL2V2ZW50XFxuJyk7XG4gIGV4cGVjdE5vV2FpdGVyKCk7XG59KTtcblxuZGVzY3JpYmUoJ1BoeXNpY2FsUmVzb3VyY2VJZCcsICgpID0+IHtcblxuICBkZXNjcmliZSgnaWYgbm90IG9taXR0ZWQgZnJvbSBvbkV2ZW50IHJlc3VsdCcsICgpID0+IHtcblxuICAgIGl0KCdkZWZhdWx0cyB0byBSZXF1ZXN0SWQgZm9yIENSRUFURScsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIFdIRU5cbiAgICAgIG1vY2tzLm9uRXZlbnRJbXBsTW9jayA9IGFzeW5jICgpID0+IHVuZGVmaW5lZDtcblxuICAgICAgLy8gVEhFTlxuICAgICAgYXdhaXQgc2ltdWxhdGVFdmVudCh7XG4gICAgICAgIFJlcXVlc3RUeXBlOiAnQ3JlYXRlJyxcbiAgICAgIH0pO1xuXG4gICAgICBleHBlY3RDbG91ZEZvcm1hdGlvblN1Y2Nlc3Moe1xuICAgICAgICBQaHlzaWNhbFJlc291cmNlSWQ6IG1vY2tzLk1PQ0tfUkVRVUVTVC5SZXF1ZXN0SWQsXG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdkZWZhdWx0cyB0byB0aGUgY3VycmVudCBQaHlzaWNhbFJlc291cmNlSWQgZm9yIFVQREFURScsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIFdIRU5cbiAgICAgIG1vY2tzLm9uRXZlbnRJbXBsTW9jayA9IGFzeW5jICgpID0+IHVuZGVmaW5lZDtcblxuICAgICAgLy8gVEhFTlxuICAgICAgYXdhaXQgc2ltdWxhdGVFdmVudCh7XG4gICAgICAgIFJlcXVlc3RUeXBlOiAnVXBkYXRlJyxcbiAgICAgICAgUGh5c2ljYWxSZXNvdXJjZUlkOiBNT0NLX1BIWVNJQ0FMX0lELFxuICAgICAgfSk7XG5cbiAgICAgIGV4cGVjdENsb3VkRm9ybWF0aW9uU3VjY2Vzcyh7XG4gICAgICAgIFBoeXNpY2FsUmVzb3VyY2VJZDogTU9DS19QSFlTSUNBTF9JRCxcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgaXQoJ2RlZmF1bHRzIHRvIHRoZSBjdXJyZW50IFBoeXNpY2FsUmVzb3VyY2VJZCBmb3IgREVMRVRFJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gV0hFTlxuICAgICAgbW9ja3Mub25FdmVudEltcGxNb2NrID0gYXN5bmMgKCkgPT4gdW5kZWZpbmVkO1xuXG4gICAgICAvLyBUSEVOXG4gICAgICBhd2FpdCBzaW11bGF0ZUV2ZW50KHtcbiAgICAgICAgUmVxdWVzdFR5cGU6ICdEZWxldGUnLFxuICAgICAgICBQaHlzaWNhbFJlc291cmNlSWQ6IE1PQ0tfUEhZU0lDQUxfSUQsXG4gICAgICB9KTtcblxuICAgICAgZXhwZWN0Q2xvdWRGb3JtYXRpb25TdWNjZXNzKHtcbiAgICAgICAgUGh5c2ljYWxSZXNvdXJjZUlkOiBNT0NLX1BIWVNJQ0FMX0lELFxuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIHRlc3QoJ1VQREFURTogY2FuIGNoYW5nZSB0aGUgcGh5c2ljYWwgSUQgYnkgcmV0dXJuaW5nIGEgbmV3IElEJywgYXN5bmMgKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgbW9ja3Mub25FdmVudEltcGxNb2NrID0gYXN5bmMgKCkgPT4gKHsgUGh5c2ljYWxSZXNvdXJjZUlkOiAnTmV3UGh5c2ljYWxJZCcgfSk7XG4gICAgbW9ja3MuaXNDb21wbGV0ZUltcGxNb2NrID0gYXN5bmMgKCkgPT4gKHsgSXNDb21wbGV0ZTogdHJ1ZSB9KTtcblxuICAgIC8vIFdIRU5cbiAgICBhd2FpdCBzaW11bGF0ZUV2ZW50KHtcbiAgICAgIFJlcXVlc3RUeXBlOiAnVXBkYXRlJyxcbiAgICAgIFBoeXNpY2FsUmVzb3VyY2VJZDogJ0N1cnJlbnRQaHlzaWNhbElkJyxcbiAgICB9KTtcblxuICAgIC8vIFRIRU5cbiAgICBleHBlY3RDbG91ZEZvcm1hdGlvblN1Y2Nlc3Moe1xuICAgICAgUGh5c2ljYWxSZXNvdXJjZUlkOiAnTmV3UGh5c2ljYWxJZCcsXG4gICAgfSk7XG4gIH0pO1xuXG4gIHRlc3QoJ0RFTEVURTogY2Fubm90IGNoYW5nZSB0aGUgcGh5c2ljYWwgcmVzb3VyY2UgSUQgZHVyaW5nIGEgZGVsZXRlJywgYXN5bmMgKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgbW9ja3Mub25FdmVudEltcGxNb2NrID0gYXN5bmMgKCkgPT4gKHsgUGh5c2ljYWxSZXNvdXJjZUlkOiAnTmV3UGh5c2ljYWxJZCcgfSk7XG4gICAgbW9ja3MuaXNDb21wbGV0ZUltcGxNb2NrID0gYXN5bmMgKCkgPT4gKHsgSXNDb21wbGV0ZTogdHJ1ZSB9KTtcblxuICAgIC8vIFdIRU5cbiAgICBhd2FpdCBzaW11bGF0ZUV2ZW50KHtcbiAgICAgIFJlcXVlc3RUeXBlOiAnRGVsZXRlJyxcbiAgICAgIFBoeXNpY2FsUmVzb3VyY2VJZDogJ0N1cnJlbnRQaHlzaWNhbElkJyxcbiAgICB9KTtcblxuICAgIC8vIFRIRU5cbiAgICBleHBlY3ROb1dhaXRlcigpO1xuICAgIGV4cGVjdENsb3VkRm9ybWF0aW9uRmFpbGVkKCdERUxFVEU6IGNhbm5vdCBjaGFuZ2UgdGhlIHBoeXNpY2FsIHJlc291cmNlIElEIGZyb20gXCJDdXJyZW50UGh5c2ljYWxJZFwiIHRvIFwiTmV3UGh5c2ljYWxJZFwiIGR1cmluZyBkZWxldGlvbicpO1xuICB9KTtcblxufSk7XG5cbnRlc3QoJ2lzQ29tcGxldGUgYWx3YXlzIHJldHVybnMgXCJmYWxzZVwiIGFuZCB0aGVuIGEgdGltZW91dCBvY2N1cnMnLCBhc3luYyAoKSA9PiB7XG4gIC8vIEdJVkVOXG4gIG1vY2tzLm9uRXZlbnRJbXBsTW9jayA9IGFzeW5jICgpID0+ICh7IERhdGE6IHsgRm9vOiAxMjMgfSwgUGh5c2ljYWxSZXNvdXJjZUlkOiBNT0NLX1BIWVNJQ0FMX0lEIH0pO1xuICBtb2Nrcy5pc0NvbXBsZXRlSW1wbE1vY2sgPSBhc3luYyAoKSA9PiAoeyBJc0NvbXBsZXRlOiBmYWxzZSB9KTtcblxuICAvLyBXSEVOXG4gIGF3YWl0IHNpbXVsYXRlRXZlbnQoe1xuICAgIFJlcXVlc3RUeXBlOiAnVXBkYXRlJyxcbiAgICBQaHlzaWNhbFJlc291cmNlSWQ6IE1PQ0tfUEhZU0lDQUxfSUQsXG4gIH0pO1xuXG4gIC8vIFRIRU5cbiAgZXhwZWN0Q2xvdWRGb3JtYXRpb25GYWlsZWQoJ09wZXJhdGlvbiB0aW1lZCBvdXQnKTtcbn0pO1xuXG50ZXN0KCdpc0NvbXBsZXRlOiBcIkRhdGFcIiBpcyBub3QgYWxsb3dlZCBpZiBJbkNvbXBsZXRlIGlzIFwiRmFsc2VcIicsIGFzeW5jICgpID0+IHtcbiAgLy8gR0lWRU5cbiAgbW9ja3Mub25FdmVudEltcGxNb2NrID0gYXN5bmMgKCkgPT4gKHsgRGF0YTogeyBGb286IDEyMyB9LCBQaHlzaWNhbFJlc291cmNlSWQ6IE1PQ0tfUEhZU0lDQUxfSUQgfSk7XG4gIG1vY2tzLmlzQ29tcGxldGVJbXBsTW9jayA9IGFzeW5jICgpID0+ICh7IElzQ29tcGxldGU6IGZhbHNlLCBEYXRhOiB7IEZvbzogMzMzMyB9IH0pO1xuXG4gIC8vIFdIRU5cbiAgYXdhaXQgc2ltdWxhdGVFdmVudCh7XG4gICAgUmVxdWVzdFR5cGU6ICdVcGRhdGUnLFxuICAgIFBoeXNpY2FsUmVzb3VyY2VJZDogTU9DS19QSFlTSUNBTF9JRCxcbiAgfSk7XG5cbiAgZXhwZWN0Q2xvdWRGb3JtYXRpb25GYWlsZWQoJ1wiRGF0YVwiIGlzIG5vdCBhbGxvd2VkIGlmIFwiSXNDb21wbGV0ZVwiIGlzIFwiRmFsc2VcIicpO1xufSk7XG5cbnRlc3QoJ2lmIHRoZXJlIGlzIG5vIHVzZXItZGVmaW5lZCBcImlzQ29tcGxldGVcIiwgdGhlIHdhaXRlciB3aWxsIG5vdCBiZSB0cmlnZ2VyZWQgb3IgbmVlZGVkJywgYXN5bmMgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBtb2Nrcy5vbkV2ZW50SW1wbE1vY2sgPSBhc3luYyAoKSA9PiAoeyBQaHlzaWNhbFJlc291cmNlSWQ6IE1PQ0tfUEhZU0lDQUxfSUQgfSk7XG5cbiAgLy8gV0hFTlxuICBhd2FpdCBzaW11bGF0ZUV2ZW50KHtcbiAgICBSZXF1ZXN0VHlwZTogJ0NyZWF0ZScsXG4gIH0pO1xuXG4gIC8vIFRIRU5cbiAgZXhwZWN0Tm9XYWl0ZXIoKTtcbiAgZXhwZWN0Q2xvdWRGb3JtYXRpb25TdWNjZXNzKHsgUGh5c2ljYWxSZXNvdXJjZUlkOiBNT0NLX1BIWVNJQ0FMX0lEIH0pO1xufSk7XG5cbnRlc3QoJ2ZhaWxzIGlmIHVzZXIgaGFuZGxlciByZXR1cm5zIGEgbm9uLW9iamVjdCByZXNwb25zZScsIGFzeW5jICgpID0+IHtcbiAgLy8gR0lWRU5cbiAgbW9ja3Muc3RyaW5naWZ5UGF5bG9hZCA9IGZhbHNlO1xuICBtb2Nrcy5vbkV2ZW50SW1wbE1vY2sgPSBhc3luYyAoKSA9PiAnc3RyaW5nJyBhcyBhbnk7XG5cbiAgLy8gV0hFTlxuICBhd2FpdCBzaW11bGF0ZUV2ZW50KHsgUmVxdWVzdFR5cGU6ICdDcmVhdGUnIH0pO1xuXG4gIC8vIFRIRU5cbiAgZXhwZWN0Q2xvdWRGb3JtYXRpb25GYWlsZWQoJ3JldHVybiB2YWx1ZXMgZnJvbSB1c2VyLWhhbmRsZXJzIG11c3QgYmUgSlNPTiBvYmplY3RzLiBnb3Q6IFxcXCJzdHJpbmdcXFwiJyk7XG59KTtcblxuZGVzY3JpYmUoJ2lmIENSRUFURSBmYWlscywgdGhlIHN1YnNlcXVlbnQgREVMRVRFIHdpbGwgYmUgaWdub3JlZCcsICgpID0+IHtcblxuICBpdCgnRkFJTEVEIHJlc3BvbnNlIHNldHMgUGh5c2ljYWxSZXNvdXJjZUlkIHRvIGEgc3BlY2lhbCBtYXJrZXInLCBhc3luYyAoKSA9PiB7XG4gICAgLy8gV0hFTlxuICAgIG1vY2tzLm9uRXZlbnRJbXBsTW9jayA9IGFzeW5jICgpID0+IHsgdGhyb3cgbmV3IEVycm9yKCdDUkVBVEUgRkFJTEVEJyk7IH07XG5cbiAgICAvLyBUSEVOXG4gICAgYXdhaXQgc2ltdWxhdGVFdmVudCh7XG4gICAgICBSZXF1ZXN0VHlwZTogJ0NyZWF0ZScsXG4gICAgfSk7XG5cbiAgICBleHBlY3RDbG91ZEZvcm1hdGlvbkZhaWxlZCgnQ1JFQVRFIEZBSUxFRFxcblxcbkxvZ3M6IC9hd3MvbGFtYmRhL2V2ZW50XFxuJywge1xuICAgICAgUGh5c2ljYWxSZXNvdXJjZUlkOiBjZm5SZXNwb25zZS5DUkVBVEVfRkFJTEVEX1BIWVNJQ0FMX0lEX01BUktFUixcbiAgICB9KTtcbiAgfSk7XG5cbiAgaXQoJ0RFTEVURSByZXF1ZXN0IHdpdGggdGhlIG1hcmtlciBzdWNjZWVkcyB3aXRob3V0IGNhbGxpbmcgdXNlciBoYW5kbGVyJywgYXN5bmMgKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgLy8gdXNlciBoYW5kbGVyIGlzIG5vdCBhc3NpZ25lZFxuXG4gICAgLy8gV0hFTlxuICAgIGF3YWl0IHNpbXVsYXRlRXZlbnQoe1xuICAgICAgUmVxdWVzdFR5cGU6ICdEZWxldGUnLFxuICAgICAgUGh5c2ljYWxSZXNvdXJjZUlkOiBjZm5SZXNwb25zZS5DUkVBVEVfRkFJTEVEX1BIWVNJQ0FMX0lEX01BUktFUixcbiAgICB9KTtcblxuICAgIC8vIFRIRU5cbiAgICBleHBlY3RDbG91ZEZvcm1hdGlvblN1Y2Nlc3MoKTtcbiAgfSk7XG5cbn0pO1xuXG4vLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG4vKipcbiAqIFRyaWdnZXJzIHRoZSBjdXN0b20gcmVzb3VyY2UgbGlmZWN5Y2xlIGV2ZW50IGZsb3cgYnkgaW52b2tpbmcgdGhlIGZyYW1ld29yaydzXG4gKiBvbkV2ZW50IGZ1bmN0aW9uIGFuZCB0aGVuLCBpZiB0aGUgd2FpdGVyIHN0YXRlIG1hY2hpbmUgd2FzIHN0YXJ0ZWQsIHNpbXVsYXRlc1xuICogdGhlIHdhaXRlciBhbmQgaW52b2tlcyBpc0NvbXBsZXRlIGFuZCBvblRpbWVvdXQgYXMgYXBwcm9wcmlhdGUuXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHNpbXVsYXRlRXZlbnQocmVxOiBQYXJ0aWFsPEFXU0xhbWJkYS5DbG91ZEZvcm1hdGlvbkN1c3RvbVJlc291cmNlRXZlbnQ+KSB7XG4gIGNvbnN0IHggPSB7XG4gICAgU2VydmljZVRva2VuOiAnU0VSVklDRS1UT0tFTicsXG4gICAgUmVzcG9uc2VVUkw6IG1vY2tzLk1PQ0tfUkVRVUVTVC5SZXNwb25zZVVSTCxcbiAgICBTdGFja0lkOiBtb2Nrcy5NT0NLX1JFUVVFU1QuU3RhY2tJZCxcbiAgICBSZXF1ZXN0SWQ6IG1vY2tzLk1PQ0tfUkVRVUVTVC5SZXF1ZXN0SWQsXG4gICAgUmVzb3VyY2VUeXBlOiAnQ3VzdG9tOjpUZXN0UmVzb3VyY2UnLFxuICAgIExvZ2ljYWxSZXNvdXJjZUlkOiBtb2Nrcy5NT0NLX1JFUVVFU1QuTG9naWNhbFJlc291cmNlSWQsXG4gICAgLi4ucmVxLFxuICB9O1xuXG4gIG1vY2tzLnByZXBhcmVGb3JFeGVjdXRpb24oKTtcblxuICBhd2FpdCBmcmFtZXdvcmsub25FdmVudCh4IGFzIEFXU0xhbWJkYS5DbG91ZEZvcm1hdGlvbkN1c3RvbVJlc291cmNlRXZlbnQpO1xuXG4gIC8vIGlmIHRoZSBGU01cbiAgaWYgKG1vY2tzLnN0YXJ0U3RhdGVNYWNoaW5lSW5wdXQgJiYgbW9ja3Muc3RhcnRTdGF0ZU1hY2hpbmVJbnB1dC5zdGF0ZU1hY2hpbmVBcm4gPT09IG1vY2tzLk1PQ0tfU0ZOX0FSTikge1xuICAgIGF3YWl0IHNpbXVsYXRlV2FpdGVyKEpTT04ucGFyc2UobW9ja3Muc3RhcnRTdGF0ZU1hY2hpbmVJbnB1dC5pbnB1dCEpKTtcbiAgfVxuXG4gIGFzeW5jIGZ1bmN0aW9uIHNpbXVsYXRlV2FpdGVyKGV2ZW50OiBBV1NDREtBc3luY0N1c3RvbVJlc291cmNlLklzQ29tcGxldGVSZXF1ZXN0KSB7XG4gICAgbGV0IHJldHJ5ID0gdHJ1ZTtcbiAgICBsZXQgY291bnQgPSA1O1xuICAgIHdoaWxlIChyZXRyeSkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgZnJhbWV3b3JrLmlzQ29tcGxldGUoZXZlbnQpO1xuICAgICAgICByZXRyeSA9IGZhbHNlO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBpZiAoZSBpbnN0YW5jZW9mIGNmblJlc3BvbnNlLlJldHJ5KSB7XG4gICAgICAgICAgaWYgKGNvdW50LS0gPT09IDApIHtcbiAgICAgICAgICAgIGF3YWl0IGZyYW1ld29yay5vblRpbWVvdXQoeyBDYXVzZTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvck1lc3NhZ2U6IGUubWVzc2FnZSB9KSB9KTtcbiAgICAgICAgICAgIHJldHJ5ID0gZmFsc2U7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHJ5ID0gdHJ1ZTtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gZXhwZWN0Q2xvdWRGb3JtYXRpb25GYWlsZWQoZXhwZWN0ZWRSZWFzb246IHN0cmluZywgcmVzcD86IFBhcnRpYWw8QVdTTGFtYmRhLkNsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VSZXNwb25zZT4pIHtcbiAgZXhwZWN0Q2xvdWRGb3JtYXRpb25SZXNwb25zZSh7XG4gICAgU3RhdHVzOiAnRkFJTEVEJyxcbiAgICBSZWFzb246IGV4cGVjdGVkUmVhc29uLFxuICAgIC4uLnJlc3AsXG4gIH0pO1xufVxuXG5mdW5jdGlvbiBleHBlY3RDbG91ZEZvcm1hdGlvblN1Y2Nlc3MocmVzcD86IFBhcnRpYWw8QVdTTGFtYmRhLkNsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VSZXNwb25zZT4pIHtcbiAgaWYgKG1vY2tzLmNmblJlc3BvbnNlLlN0YXR1cyAhPT0gJ1NVQ0NFU1MnKSB7XG4gICAgY29uc29sZS5lcnJvcihtb2Nrcy5jZm5SZXNwb25zZS5SZWFzb24gfHwgJzxOTyBSRUFTT04+Jyk7XG4gIH1cblxuICBleHBlY3RDbG91ZEZvcm1hdGlvblJlc3BvbnNlKHsgU3RhdHVzOiAnU1VDQ0VTUycsIC4uLnJlc3AgfSk7XG59XG5cbmZ1bmN0aW9uIGV4cGVjdENsb3VkRm9ybWF0aW9uUmVzcG9uc2UocmVzcDogUGFydGlhbDxBV1NMYW1iZGEuQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZVJlc3BvbnNlPiA9IHt9KSB7XG4gIGZvciAoY29uc3QgW2tleSwgZXhwZWN0ZWRdIG9mIE9iamVjdC5lbnRyaWVzKHJlc3ApKSB7XG4gICAgY29uc3QgYWN0dWFsID0gKG1vY2tzLmNmblJlc3BvbnNlIGFzIGFueSlba2V5XTtcbiAgICBleHBlY3QoYWN0dWFsKS50b1N0cmljdEVxdWFsKGV4cGVjdGVkIGFzIGFueSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gZXhwZWN0Tm9XYWl0ZXIoKSB7XG4gIGV4cGVjdChtb2Nrcy5zdGFydFN0YXRlTWFjaGluZUlucHV0KS50b0JlVW5kZWZpbmVkKCk7XG59XG4iXX0=